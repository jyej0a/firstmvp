# Rate Limiting ê°€ì´ë“œ

**ì‘ì„±ì¼:** 2024-12-04  
**ëª©ì :** Amazon Bot Detection íšŒí”¼ ë° ì„œë²„ ë¶€í•˜ ê´€ë¦¬

---

## ê°œìš”

ì´ ì‹œìŠ¤í…œì€ ì•„ë§ˆì¡´ ìŠ¤í¬ë˜í•‘ ì‹œ Bot Detection(IP ì°¨ë‹¨, CAPTCHA)ì„ íšŒí”¼í•˜ê³   
ì„œë²„ ë¶€í•˜ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ **í™˜ê²½ë³„ Rate Limiting**ì„ ì ìš©í•©ë‹ˆë‹¤.

## í™˜ê²½ë³„ ì„¤ì •

### ğŸ”§ ê°œë°œ í™˜ê²½ (Development)

```bash
NODE_ENV=development
```

**íŠ¹ì§•:**
- âœ… **Rate Limiting ë¹„í™œì„±í™”**
- âœ… ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- âœ… í˜ì´ì§€ ê°„ ë”œë ˆì´: **1-3ì´ˆ**
- âš ï¸  Amazon ì°¨ë‹¨ ìœ„í—˜ ìˆìŒ (ê°œë°œìš©ì´ë¯€ë¡œ í—ˆìš©)

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ë¡œì»¬ ê°œë°œ ë° í…ŒìŠ¤íŠ¸
- ê¸°ëŠ¥ ê²€ì¦
- ë””ë²„ê¹…

### ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ (Production)

```bash
NODE_ENV=production
```

**íŠ¹ì§•:**
- âœ… **ì—„ê²©í•œ Rate Limiting í™œì„±í™”**
- âœ… Amazon Bot Detection íšŒí”¼
- âœ… í˜ì´ì§€ ê°„ ë”œë ˆì´: **3-5ì´ˆ**
- âœ… IPë³„ ìš”ì²­ ì œí•œ

**Rate Limit ê·œì¹™:**
1. **ìµœì†Œ ìš”ì²­ ê°„ê²©:** 60ì´ˆ (1ë¶„)
   - ê°™ì€ IPì—ì„œ ì—°ì† ìš”ì²­ ì‹œ ìµœì†Œ 1ë¶„ ëŒ€ê¸°
2. **ì‹œê°„ ìœˆë„ìš° ì œí•œ:** 5ë¶„ ë‚´ ìµœëŒ€ 3íšŒ
   - 5ë¶„ ë™ì•ˆ 3íšŒ ì´ìƒ ìš”ì²­ ë¶ˆê°€

## Rate Limiting ë™ì‘ ë°©ì‹

### ìš”ì²­ í”Œë¡œìš°

```
ì‚¬ìš©ì ìš”ì²­
    â†“
Rate Limiter ì²´í¬
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê°œë°œ í™˜ê²½?                   â”‚
â”‚ â””â”€ Yes â†’ ì¦‰ì‹œ í—ˆìš©          â”‚
â”‚ â””â”€ No  â†’ í”„ë¡œë•ì…˜ ê·œì¹™ ì ìš©  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìµœì†Œ ê°„ê²© ì²´í¬ (60ì´ˆ)        â”‚
â”‚ â””â”€ ë¯¸ë‹¬ â†’ 429 ì—ëŸ¬ ë°˜í™˜     â”‚
â”‚ â””â”€ í†µê³¼ â†’ ë‹¤ìŒ ì²´í¬         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìœˆë„ìš° ë‚´ íšŸìˆ˜ ì²´í¬ (3íšŒ)    â”‚
â”‚ â””â”€ ì´ˆê³¼ â†’ 429 ì—ëŸ¬ ë°˜í™˜     â”‚
â”‚ â””â”€ í†µê³¼ â†’ ìš”ì²­ í—ˆìš©         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ìŠ¤í¬ë˜í•‘ ì‹¤í–‰
```

### ì—ëŸ¬ ì‘ë‹µ (429 Too Many Requests)

```json
{
  "success": false,
  "error": "ë„ˆë¬´ ë§ì€ ìš”ì²­ì…ë‹ˆë‹¤. 45ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
  "retryAfter": 45
}
```

**í—¤ë”:**
```
Retry-After: 45
```

## Bot Detection ëŒ€ì‘ ì „ëµ

### 1. User-Agent ìœ„ì¥

```typescript
// ìµœì‹  Chrome ë¸Œë¼ìš°ì €ë¡œ ìœ„ì¥
const USER_AGENT = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...";
```

### 2. Automation í”Œë˜ê·¸ ì œê±°

```typescript
args: [
  "--disable-blink-features=AutomationControlled",
  "--no-sandbox",
]
```

### 3. Navigator.webdriver ì œê±°

```typescript
await page.evaluateOnNewDocument(() => {
  Object.defineProperty(navigator, "webdriver", {
    get: () => undefined,
  });
});
```

### 4. ëœë¤ ë”œë ˆì´ (ìì—°ìŠ¤ëŸ¬ìš´ ì‚¬ìš©ì í–‰ë™)

- **ê°œë°œ:** 1-3ì´ˆ
- **í”„ë¡œë•ì…˜:** 3-5ì´ˆ

```typescript
// í˜ì´ì§€ ê°„ ì´ë™ ì‹œ ìë™ ë”œë ˆì´
await randomDelay(); // 3-5ì´ˆ
await goToNextPage();
```

### 5. IPë³„ ìš”ì²­ ì œí•œ

- ë™ì¼ IPì—ì„œ ì—°ì† ìš”ì²­ ë°©ì§€
- 5ë¶„ì— ìµœëŒ€ 3íšŒë¡œ ì œí•œ

## ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§•

### Rate Limit ì„¤ì • ë³€ê²½

`lib/utils/rate-limiter.ts`:

```typescript
const RATE_LIMIT_CONFIG = {
  enableInDevelopment: false, // ê°œë°œ í™˜ê²½ ì œí•œ í™œì„±í™” ì—¬ë¶€
  minIntervalSeconds: 60,     // ìµœì†Œ ê°„ê²© (ì´ˆ)
  windowMs: 5 * 60 * 1000,    // ì‹œê°„ ìœˆë„ìš° (ë°€ë¦¬ì´ˆ)
  maxRequests: 3,             // ìœˆë„ìš° ë‚´ ìµœëŒ€ íšŸìˆ˜
};
```

### ë”œë ˆì´ ì„¤ì • ë³€ê²½

`lib/scraper/amazon-scraper.ts`:

```typescript
// í”„ë¡œë•ì…˜
const MIN_DELAY_MS = 3000; // 3ì´ˆ
const MAX_DELAY_MS = 5000; // 5ì´ˆ

// ê°œë°œ
const MIN_DELAY_MS = 1000; // 1ì´ˆ
const MAX_DELAY_MS = 3000; // 3ì´ˆ
```

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸

```bash
# 1. ê°œë°œ ì„œë²„ ì‹¤í–‰ (ìë™ìœ¼ë¡œ development ëª¨ë“œ)
pnpm dev

# 2. API í…ŒìŠ¤íŠ¸ (ì œí•œ ì—†ìŒ)
pnpm test:api
```

### í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜

```bash
# 1. í”„ë¡œë•ì…˜ ë¹Œë“œ
pnpm build

# 2. í”„ë¡œë•ì…˜ ì„œë²„ ì‹¤í–‰
NODE_ENV=production pnpm start

# 3. ì—°ì† ìš”ì²­ í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:3000/api/scrape \
  -H "Content-Type: application/json" \
  -d '{"searchInput": "phone stand"}'

# 60ì´ˆ ì´ë‚´ ì¬ìš”ì²­ ì‹œ 429 ì—ëŸ¬ í™•ì¸
```

## ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### Rate Limit ìƒíƒœ í™•ì¸ (ê°œë°œ í™˜ê²½)

API Routeì— ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ê°€ëŠ¥:

```typescript
// app/api/scrape/stats/route.ts
import { getRateLimitStats } from "@/lib/utils/rate-limiter";

export async function GET() {
  const stats = getRateLimitStats();
  return Response.json(stats);
}
```

### ë¡œê·¸ í™•ì¸

```
âœ… [Rate Limiter] ìš”ì²­ í—ˆìš© (192.168.1.1) - 1/3
âš ï¸  [Rate Limiter] ìš”ì²­ ê±°ë¶€ (192.168.1.1) - ìµœì†Œ ê°„ê²© ë¯¸ë‹¬ (45ì´ˆ í›„ ì¬ì‹œë„)
```

## í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `NODE_ENV=production` ì„¤ì • í™•ì¸
- [ ] Rate Limiting í™œì„±í™” í™•ì¸
- [ ] í”„ë¡œë•ì…˜ ë”œë ˆì´ ì„¤ì • í™•ì¸ (3-5ì´ˆ)
- [ ] 429 ì—ëŸ¬ ì‘ë‹µ í…ŒìŠ¤íŠ¸
- [ ] Vercel/í˜¸ìŠ¤íŒ… í™˜ê²½ì—ì„œ IP ì¶”ì¶œ í™•ì¸

## FAQ

### Q1. ê°œë°œ ì¤‘ì—ë„ Rate Limitingì„ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ì–´ìš”

`lib/utils/rate-limiter.ts`ì—ì„œ:
```typescript
enableInDevelopment: true
```

### Q2. Rate Limitì„ ë” ì—„ê²©í•˜ê²Œ í•˜ê³  ì‹¶ì–´ìš”

```typescript
minIntervalSeconds: 120,  // 2ë¶„ìœ¼ë¡œ ì¦ê°€
maxRequests: 2,           // 5ë¶„ì— 2íšŒë¡œ ê°ì†Œ
```

### Q3. íŠ¹ì • IPë¥¼ ì°¨ë‹¨ì—ì„œ í•´ì œí•˜ê³  ì‹¶ì–´ìš”

```typescript
import { resetRateLimitForIp } from "@/lib/utils/rate-limiter";

// ê´€ë¦¬ì API ë“±ì—ì„œ í˜¸ì¶œ
resetRateLimitForIp("192.168.1.1");
```

### Q4. Amazonì—ì„œ ì°¨ë‹¨ë‹¹í–ˆì–´ìš”

1. **ì¼ì‹œì  ì°¨ë‹¨:** 1-2ì‹œê°„ ëŒ€ê¸° í›„ ì¬ì‹œë„
2. **ì¥ê¸° ì°¨ë‹¨:** IP ë³€ê²½ ë˜ëŠ” í”„ë¡ì‹œ ì‚¬ìš© ê³ ë ¤
3. **Rate Limit ê°•í™”:** ìš”ì²­ ê°„ê²©ì„ 2-3ë¶„ìœ¼ë¡œ ì¦ê°€

## ì¶”ê°€ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### í–¥í›„ ê°œì„  ê°€ëŠ¥í•œ ì‚¬í•­

1. **í”„ë¡ì‹œ ë¡œí…Œì´ì…˜**
   - ì—¬ëŸ¬ IPë¥¼ ìˆœí™˜í•˜ì—¬ ì‚¬ìš©
   - Phase 0-1ì—ì„œ ì¡°ì‚¬í•œ í”„ë¡ì‹œ ì„œë¹„ìŠ¤ í™œìš©

2. **ì„¸ì…˜ ì¿ í‚¤ ê´€ë¦¬**
   - ë¸Œë¼ìš°ì € ì„¸ì…˜ ì¬ì‚¬ìš©
   - ì¿ í‚¤ í’€(Pool) êµ¬í˜„

3. **ìš”ì²­ í**
   - ìš”ì²­ì„ íì— ì €ì¥í•˜ì—¬ ìˆœì°¨ ì²˜ë¦¬
   - ë™ì‹œ ìš”ì²­ ë°©ì§€

4. **IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**
   - ê´€ë¦¬ì IP ì œí•œ í•´ì œ
   - VIP ì‚¬ìš©ì ìš°ëŒ€

---

**ì°¸ê³  ë¬¸ì„œ:**
- [PRD.md](./PRD.md) - ë¦¬ìŠ¤í¬ ê´€ë¦¬
- [TODO.md](./TODO.md) - êµ¬í˜„ ê³„íš
- [proxy-services-research.md](./proxy-services-research.md) - í”„ë¡ì‹œ ì¡°ì‚¬

